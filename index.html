<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤í¬ë¦°ê³¨í”„ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .room-card { transition: 0.3s; cursor: pointer; }
        .room-card:hover { transform: translateY(-5px); shadow: lg; }
        .status-badge { font-size: 0.9em; }
        .reserved-slot { background-color: #ffebee; border-left: 4px solid #dc3545; font-size: 0.85rem; padding: 4px;}
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999; display: none;
            justify-content: center; align-items: center;
        }
    </style>
</head>
<body class="bg-light">

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<div class="container py-4">
    <h2 class="mb-4 text-center fw-bold">â›³ ìŠ¤í¬ë¦°ê³¨í”„ ì˜ˆì•½ ì‹œìŠ¤í…œ</h2>

    <h5 class="mb-3">ğŸ”´ í˜„ì¬ ì‚¬ìš© í˜„í™©</h5>
    <div class="row g-3 mb-5" id="roomStatusContainer">
        </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>ğŸ“… ì£¼ê°„ ì˜ˆì•½ í˜„í™©</h5>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reservationModal">
            + ìƒˆ ì˜ˆì•½í•˜ê¸°
        </button>
    </div>

    <ul class="nav nav-tabs mb-3" id="dateTabs">
        </ul>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered text-center" style="min-width: 600px;">
                    <thead class="table-light">
                        <tr>
                            <th style="width:10%">ì‹œê°„</th>
                            <th style="width:18%">Room 1</th>
                            <th style="width:18%">Room 2</th>
                            <th style="width:18%">Room 3 (GDR+)</th>
                            <th style="width:18%">Room 4 (ì–‘ì†)</th>
                            <th style="width:18%">Room 5 (ê°œì¸)</th>
                        </tr>
                    </thead>
                    <tbody id="timetableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reservationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì˜ˆì•½í•˜ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <div class="mb-3">
                        <label class="form-label">ë‚ ì§œ ì„ íƒ</label>
                        <input type="date" class="form-control" id="inputDate" required>
                        <small class="text-muted" id="dateHelp"></small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ë°© ì„ íƒ</label>
                        <select class="form-select" id="inputRoom" required>
                            <option value="Room 1">Room 1</option>
                            <option value="Room 2">Room 2</option>
                            <option value="Room 3">Room 3 (ìŠ¤ìœ™ë¶„ì„ê¸°, GDR+)</option>
                            <option value="Room 4">Room 4 (ì–‘ì†ì¡ì´)</option>
                            <option value="Room 5">Room 5 (ê°œì¸í›ˆë ¨)</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">ì¸ì›ìˆ˜</label>
                            <select class="form-select" id="inputPax" required>
                                <option value="1">1ëª… (ìµœëŒ€ 1ì‹œê°„)</option>
                                <option value="2">2ëª… (ìµœëŒ€ 2ì‹œê°„)</option>
                                <option value="3">3ëª… (ìµœëŒ€ 3ì‹œê°„)</option>
                                <option value="4">4ëª… (ìµœëŒ€ 3ì‹œê°„)</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">ì´ìš© ì‹œê°„</label>
                            <select class="form-select" id="inputDuration" required>
                                </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì‹œì‘ ì‹œê°„</label>
                        <select class="form-select" id="inputStartTime" required>
                            </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì˜ˆì•½ì ëª…ë‹¨</label>
                        <div id="nameInputsContainer">
                            </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitReservation()">ì˜ˆì•½ í™•ì •</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ==========================================
    // âš ï¸ [ì¤‘ìš”] ë°°í¬í•œ GAS URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”
    // ==========================================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzrhaaFAwh7RDeEmU1ezIRSHpZo9t1-2rOHbXq3XiVC-wOqSndpcksB99Ncf2_uW3EJ/exec"; 
    
    let allReservations = [];
    let currentDateTab = new Date(); // í˜„ì¬ ë³´ê³  ìˆëŠ” íƒ­ì˜ ë‚ ì§œ

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        initDateTabs();
        fetchReservations();
        
        // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('inputDate').addEventListener('change', updateTimeOptions);
        document.getElementById('inputPax').addEventListener('change', () => {
            updateDurationOptions();
            updateNameInputs();
        });
        
        // ì´ˆê¸°ê°’ ì„¤ì •
        document.getElementById('inputDate').min = new Date().toISOString().split("T")[0];
        updateNameInputs(); // ì´ˆê¸° 1ëª… ì…ë ¥ì¹¸
    });

    // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function fetchReservations() {
        showLoading(true);
        fetch(GAS_URL)
            .then(res => res.json())
            .then(json => {
                if(json.status === 'success') {
                    allReservations = json.data;
                    renderRealTimeStatus();
                    renderTimetable(currentDateTab);
                } else {
                    alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
            })
            .catch(err => console.error(err))
            .finally(() => showLoading(false));
    }

    // 2. ì‹¤ì‹œê°„ í˜„í™© ë Œë”ë§
    function renderRealTimeStatus() {
        const container = document.getElementById('roomStatusContainer');
        container.innerHTML = '';
        
        const rooms = [
            { id: 'Room 1', desc: 'ì¼ë°˜' },
            { id: 'Room 2', desc: 'ì¼ë°˜' },
            { id: 'Room 3', desc: 'GDR Plus' },
            { id: 'Room 4', desc: 'ì–‘ì†ì¡ì´' },
            { id: 'Room 5', desc: 'ê°œì¸í›ˆë ¨' }
        ];

        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        const currentHour = now.getHours();

        rooms.forEach(room => {
            // í˜„ì¬ ë°©ì„ ì“°ê³  ìˆëŠ” ì˜ˆì•½ ì°¾ê¸°
            const activeRes = allReservations.find(res => {
                const start = parseInt(res.StartTime);
                const end = start + parseInt(res.Duration);
                return res.Date === todayStr && res.Room === room.id && currentHour >= start && currentHour < end;
            });

            const isOccupied = !!activeRes;
            const badgeClass = isOccupied ? 'bg-danger' : 'bg-success';
            const statusText = isOccupied ? `ì‚¬ìš© ì¤‘ (${activeRes.Names})` : 'ë¹„ì–´ ìˆìŒ';

            const html = `
                <div class="col-md-2dot4 col-6"> <div class="card room-card shadow-sm h-100 border-${isOccupied ? 'danger' : 'success'}">
                        <div class="card-body text-center p-2">
                            <h6 class="card-title fw-bold">${room.id}</h6>
                            <p class="card-text text-muted small mb-2">${room.desc}</p>
                            <span class="badge ${badgeClass} status-badge">${statusText}</span>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // 3. ì£¼ê°„ ë‚ ì§œ íƒ­ ìƒì„±
    function initDateTabs() {
        const tabsContainer = document.getElementById('dateTabs');
        const today = new Date();
        
        for(let i=0; i<7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const dayName = getDayName(date.getDay());
            
            const li = document.createElement('li');
            li.className = 'nav-item';
            li.innerHTML = `
                <a class="nav-link ${i===0 ? 'active' : ''}" href="#" 
                   onclick="switchTab(this, '${dateStr}')">
                   ${date.getMonth()+1}/${date.getDate()} (${dayName})
                </a>
            `;
            tabsContainer.appendChild(li);
        }
        currentDateTab = new Date(today); // ì´ˆê¸°ê°’ ì˜¤ëŠ˜
    }

    function switchTab(element, dateStr) {
        // íƒ­ í™œì„±í™” UI ë³€ê²½
        document.querySelectorAll('#dateTabs .nav-link').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        currentDateTab = new Date(dateStr);
        renderTimetable(currentDateTab);
    }

    // 4. íƒ€ì„í…Œì´ë¸” ë Œë”ë§
    function renderTimetable(targetDateObj) {
        const tbody = document.getElementById('timetableBody');
        tbody.innerHTML = '';
        const targetDateStr = targetDateObj.toISOString().split('T')[0];
        
        // ìš´ì˜ ì‹œê°„ ê³„ì‚°
        const day = targetDateObj.getDay(); // 0(ì¼)~6(í† )
        let startHour, endHour;

        // í† (6), ì¼(0), ì›”(1), í™”(2), ìˆ˜(3) -> 19~22
        if ([6, 0, 1, 2, 3].includes(day)) {
            startHour = 19; endHour = 22;
        } else if (day === 4) { // ëª©ìš”ì¼ -> 17~22
            startHour = 17; endHour = 22;
        } else if (day === 5) { // ê¸ˆìš”ì¼ -> 06~22
            startHour = 6; endHour = 22;
        }

        // ì‹œê°„ í–‰ ìƒì„±
        for (let h = startHour; h < endHour; h++) {
            let rowHtml = `<tr><td class="align-middle">${h}:00</td>`;
            
            for (let r = 1; r <= 5; r++) {
                const roomName = `Room ${r}`;
                
                // í•´ë‹¹ ì…€ì— ì˜ˆì•½ì´ ìˆëŠ”ì§€ í™•ì¸
                const booking = allReservations.find(res => {
                    const rStart = parseInt(res.StartTime);
                    const rDuration = parseInt(res.Duration);
                    return res.Date === targetDateStr && res.Room === roomName && h >= rStart && h < (rStart + rDuration);
                });

                if (booking) {
                    // ì˜ˆì•½ ì •ë³´ í‘œì‹œ (ì´ë¦„ í¬í•¨)
                    rowHtml += `<td class="reserved-slot align-middle">
                        <div class="fw-bold">${booking.Names}</div>
                        <small>(${booking.Pax}ëª…)</small>
                    </td>`;
                } else {
                    rowHtml += `<td></td>`;
                }
            }
            rowHtml += `</tr>`;
            tbody.innerHTML += rowHtml;
        }
    }

    // 5. ëª¨ë‹¬: ìš”ì¼ë³„ ì‹œê°„ ì˜µì…˜ ì—…ë°ì´íŠ¸
    function updateTimeOptions() {
        const dateInput = document.getElementById('inputDate').value;
        if(!dateInput) return;

        const date = new Date(dateInput);
        const day = date.getDay();
        const helpText = document.getElementById('dateHelp');
        const timeSelect = document.getElementById('inputStartTime');
        timeSelect.innerHTML = '';

        let start, end, info;
        
        if ([6, 0, 1, 2, 3].includes(day)) { // í† ~ìˆ˜
            start = 19; end = 22; info = "ìš´ì˜ì‹œê°„: 19:00 ~ 22:00";
        } else if (day === 4) { // ëª©
            start = 17; end = 22; info = "ìš´ì˜ì‹œê°„: 17:00 ~ 22:00";
        } else { // ê¸ˆ
            start = 6; end = 22; info = "ìš´ì˜ì‹œê°„: 06:00 ~ 22:00";
        }
        
        helpText.innerText = info;

        for(let i=start; i<end; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = `${i}:00`;
            timeSelect.appendChild(option);
        }
    }

    // 6. ëª¨ë‹¬: ì¸ì›ìˆ˜ë³„ ì‹œê°„ ì œí•œ ë° ì´ë¦„ ì…ë ¥ì¹¸ ìƒì„±
    function updateDurationOptions() {
        const pax = parseInt(document.getElementById('inputPax').value);
        const durationSelect = document.getElementById('inputDuration');
        durationSelect.innerHTML = '';
        
        let maxTime = 1;
        if(pax === 2) maxTime = 2;
        if(pax >= 3) maxTime = 3;

        for(let i=1; i<=maxTime; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = `${i}ì‹œê°„`;
            durationSelect.appendChild(opt);
        }
        // ê¸°ë³¸ê°’ì€ ìµœëŒ€ë¡œ ì„ íƒí•´ì£¼ë©´ í¸í•¨
        durationSelect.value = maxTime;
    }

    function updateNameInputs() {
        const pax = parseInt(document.getElementById('inputPax').value);
        const container = document.getElementById('nameInputsContainer');
        container.innerHTML = '';

        for(let i=1; i<=pax; i++) {
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <span class="input-group-text">ì°¸ê°€ì ${i}</span>
                <input type="text" class="form-control name-input" placeholder="ì´ë¦„ ì…ë ¥" required>
            `;
            container.appendChild(div);
        }
    }

    // 7. ì˜ˆì•½ ì „ì†¡
    function submitReservation() {
        const date = document.getElementById('inputDate').value;
        const room = document.getElementById('inputRoom').value;
        const pax = document.getElementById('inputPax').value;
        const duration = document.getElementById('inputDuration').value;
        const startTime = document.getElementById('inputStartTime').value;
        
        // ì´ë¦„ ìˆ˜ì§‘
        const nameInputs = document.querySelectorAll('.name-input');
        let namesArr = [];
        let allFilled = true;
        nameInputs.forEach(input => {
            if(!input.value.trim()) allFilled = false;
            namesArr.push(input.value.trim());
        });

        if(!date || !room || !allFilled) {
            alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const payload = {
            date: date,
            room: room,
            pax: pax,
            duration: duration,
            startTime: startTime,
            names: namesArr.join(', ') // "ê¹€ì² ìˆ˜, ì´ì˜í¬" í˜•íƒœë¡œ ì €ì¥
        };

        if(!confirm(`${date} ${startTime}ì‹œ\n${room} ì˜ˆì•½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì°¸ê°€ì: ${payload.names}`)) return;

        // ëª¨ë‹¬ ë‹«ê¸° ë° ë¡œë”© ì‹œì‘
        const modalEl = document.getElementById('reservationModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
        showLoading(true);

        // POST ìš”ì²­
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(payload) // no-cors ëª¨ë“œ ì•„ë‹˜ (ì‘ë‹µ ë°›ì•„ì•¼í•¨)
        })
        .then(res => res.json())
        .then(json => {
            if(json.status === 'success') {
                alert(json.message);
                fetchReservations(); // ë°ì´í„° ê°±ì‹ 
                document.getElementById('bookingForm').reset();
                updateNameInputs(); // í¼ ë¦¬ì…‹ í›„ ì…ë ¥ì¹¸ ì´ˆê¸°í™”
            } else {
                alert('ì‹¤íŒ¨: ' + json.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => showLoading(false));
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }
    
    function getDayName(idx) {
        const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        return days[idx];
    }
</script>
</body>
</html>
